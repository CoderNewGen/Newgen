import React from 'react';
import { render, screen, waitFor } from '@testing-library/react';
import { MemoryRouter } from 'react-router-dom';
import AppSelector from './AppSelector';
import Registration from '../Registration/index';
import CookiePage from '../Registration/cookiePage/index';
import Accessibility from '../Registration/AccessibilityPage';
import AccessibilityCessation from '../Cessation/AccessibilityPage';
import Cessation from '../Cessation';
import AppealsAndPenalties from '../AppealsAndPenalties';
import AccessibilityAppealsAndPenalties from '../AppealsAndPenalties/AccessibilityPage';
import ProtectedRoute from '../../components/HOC/ProtectedRoute';
import AppWrapper from '../../components/AppComponents/AppWrapper';

// Mock i18n initialization
jest.mock('i18next', () => ({
  use: jest.fn(),
  init: jest.fn(() => Promise.resolve()),
}));

// Mock components
jest.mock('../Registration/index', () => () => <div>Registration Component</div>);
jest.mock('../Registration/cookiePage/index', () => () => <div>CookiePage Component</div>);
jest.mock('../Registration/AccessibilityPage', () => () => <div>Accessibility Component</div>);
jest.mock('../Cessation/AccessibilityPage', () => () => <div>AccessibilityCessation Component</div>);
jest.mock('../Cessation', () => () => <div>Cessation Component</div>);
jest.mock('../AppealsAndPenalties', () => () => <div>AppealsAndPenalties Component</div>);
jest.mock('../AppealsAndPenalties/AccessibilityPage', () => () => <div>AccessibilityAppealsAndPenalties Component</div>);
jest.mock('../../components/HOC/ProtectedRoute', () => ({ component: Component }) => <div>ProtectedRoute: <Component /></div>);
jest.mock('../../components/AppComponents/AppWrapper', () => ({ children }) => <div>AppWrapper: {children}</div>);

describe('AppSelector Component', () => {
  beforeEach(() => {
    // Clear sessionStorage and reset mocks
    sessionStorage.clear();
    jest.clearAllMocks();
  });

  test('renders nothing until i18n is loaded', async () => {
    render(
      <MemoryRouter>
        <AppSelector />
      </MemoryRouter>
    );

    // Initially, nothing should be rendered
    expect(screen.queryByText('Registration Component')).toBeNull();

    // Wait for i18n to load and check if Registration Component is rendered
    await waitFor(() => {
      expect(screen.getByText('Registration Component')).toBeInTheDocument();
    });
  });

  test('redirects to /registration by default', async () => {
    render(
      <MemoryRouter initialEntries={['/']}>
        <AppSelector />
      </MemoryRouter>
    );

    // Wait for the redirect to /registration
    await waitFor(() => {
      expect(screen.getByText('Registration Component')).toBeInTheDocument();
    });
  });

  test('renders protected routes with ProtectedRoute wrapper', async () => {
    render(
      <MemoryRouter initialEntries={['/registration']}>
        <AppSelector />
      </MemoryRouter>
    );

    // Wait for ProtectedRoute to render
    await waitFor(() => {
      expect(screen.getByText('ProtectedRoute:')).toBeInTheDocument();
    });

    // Verify that the Registration Component is rendered inside ProtectedRoute
    expect(screen.getByText('Registration Component')).toBeInTheDocument();
  });

  test('renders public routes with AppWrapper', async () => {
    render(
      <MemoryRouter initialEntries={['/registration-cookies']}>
        <AppSelector />
      </MemoryRouter>
    );

    // Wait for AppWrapper to render
    await waitFor(() => {
      expect(screen.getByText('AppWrapper:')).toBeInTheDocument();
    });

    // Verify that the CookiePage Component is rendered inside AppWrapper
    expect(screen.getByText('CookiePage Component')).toBeInTheDocument();
  });

  test('renders cessation accessibility route', async () => {
    render(
      <MemoryRouter initialEntries={['/cessation-accessibility']}>
        <AppSelector />
      </MemoryRouter>
    );

    // Wait for AppWrapper to render
    await waitFor(() => {
      expect(screen.getByText('AppWrapper:')).toBeInTheDocument();
    });

    // Verify that the AccessibilityCessation Component is rendered inside AppWrapper
    expect(screen.getByText('AccessibilityCessation Component')).toBeInTheDocument();
  });

  test('renders appeals and penalties accessibility route', async () => {
    render(
      <MemoryRouter initialEntries={['/appeal-a-self-assessment-penalty-accessibility']}>
        <AppSelector />
      </MemoryRouter>
    );

    // Wait for AppWrapper to render
    await waitFor(() => {
      expect(screen.getByText('AppWrapper:')).toBeInTheDocument();
    });

    // Verify that the AccessibilityAppealsAndPenalties Component is rendered inside AppWrapper
    expect(screen.getByText('AccessibilityAppealsAndPenalties Component')).toBeInTheDocument();
  });
});
