import React, { useCallback, useEffect } from 'react';
import Modal from '../../BaseComponents/Modal/Modal';
import Button from '../../BaseComponents/Button/Button';
import { useTranslation } from 'react-i18next';
import { useTimeout } from './TimeoutReducer';

const TimeoutPopup = ({
  show,
  millisecondsTillSignout = 120000,
  staySignedinHandler,
  signoutHandler,
  staySignedInButtonText,
  signoutButtonText,
  children,
}) => {
  const { t } = useTranslation();
  const timeoutState = useTimeout(show, millisecondsTillSignout, signoutHandler);

  const handleKeyPress = useCallback(
    (event) => {
      if (event.key === 'Escape') staySignedinHandler();
    },
    [staySignedinHandler]
  );

  useEffect(() => {
    if (show) {
      window.addEventListener('keydown', handleKeyPress);
    } else {
      window.removeEventListener('keydown', handleKeyPress);
    }
    return () => window.removeEventListener('keydown', handleKeyPress);
  }, [show, handleKeyPress]);

  const renderTimeoutText = () => {
    if (timeoutState.countdownStart) {
      const { timeRemaining } = timeoutState;
      if (timeRemaining === 60) return `${t('1_MINUTE')}.`;
      if (timeRemaining === 1) return `${timeRemaining} ${t('SECOND')}.`;
      return `${timeRemaining} ${t('SECONDS')}.`;
    }
    return `${t('2_MINUTES')}.`;
  };

  return (
    <Modal show={show} id="timeout-popup">
      <div>
        {children || (
          <>
            <h1 id="govuk-timeout-heading" className="govuk-heading-m push--top">
              {t('YOURE_ABOUT_TO_BE_SIGNED_OUT')}
            </h1>
            <p className="govuk-body">
              {`${t('FOR_YOUR_SECURITY_WE_WILL_SIGN_YOU_OUT')} `}
              <span className="govuk-!-font-weight-bold">{renderTimeoutText()}</span>
              {timeoutState.countdownStart && (
                <span className="govuk-visually-hidden" aria-live="polite">
                  {timeoutState.screenReaderCountdown}
                </span>
              )}
            </p>
            <div className="govuk-button-group govuk-!-padding-top-4">
              <Button type="button" onClick={staySignedinHandler}>
                {staySignedInButtonText}
              </Button>

              <a id="modal-signout-btn" className="govuk-link" href="#" onClick={signoutHandler}>
                {signoutButtonText}
              </a>
            </div>
          </>
        )}
      </div>
    </Modal>
  );
};

export default TimeoutPopup;

import { useReducer, useEffect } from 'react';
import { useTranslation } from 'react-i18next';

const DEFAULT_SIGNOUT_TIME = 120000;
const COUNTDOWN_START_OFFSET = 60000;
const INITIAL_TIME_REMAINING = 60;
const UPDATE_INTERVAL = 1000;
const SIGNOUT_DELAY = 1000;
const SCREEN_READER_UPDATE_INTERVAL = 20;

const initialTimeoutState = {
  countdownStart: false,
  timeRemaining: INITIAL_TIME_REMAINING,
  screenReaderCountdown: '',
};

const timeoutReducer = (state, action) => {
  switch (action.type) {
    case 'START_COUNTDOWN':
      return { ...state, countdownStart: action.payload };
    case 'UPDATE_TIME_REMAINING':
      return { ...state, timeRemaining: action.payload };
    case 'UPDATE_SCREEN_READER_COUNTDOWN':
      return { ...state, screenReaderCountdown: action.payload };
    default:
      return state;
  }
};

const useTimeout = (show, millisecondsTillSignout, signoutHandler) => {
  const { t } = useTranslation();
  const [timeoutState, dispatch] = useReducer(timeoutReducer, initialTimeoutState);

  useEffect(() => {
    if (!show) {
      dispatch({ type: 'UPDATE_TIME_REMAINING', payload: INITIAL_TIME_REMAINING });
      dispatch({ type: 'UPDATE_SCREEN_READER_COUNTDOWN', payload: '' });
      dispatch({ type: 'START_COUNTDOWN', payload: false });
      return;
    }

    const startCountdown = setTimeout(() => {
      dispatch({ type: 'START_COUNTDOWN', payload: true });
    }, millisecondsTillSignout - COUNTDOWN_START_OFFSET);

    return () => clearTimeout(startCountdown);
  }, [show, millisecondsTillSignout]);

  useEffect(() => {
    if (!timeoutState.countdownStart || timeoutState.timeRemaining === 0) return;

    const intervalId = setInterval(() => {
      dispatch({ type: 'UPDATE_TIME_REMAINING', payload: timeoutState.timeRemaining - 1 });
    }, UPDATE_INTERVAL);

    return () => clearInterval(intervalId);
  }, [timeoutState.countdownStart, timeoutState.timeRemaining]);

  useEffect(() => {
    if (timeoutState.timeRemaining === 0) {
      const signoutTimeout = setTimeout(() => signoutHandler(new MouseEvent('click')), SIGNOUT_DELAY);
      return () => clearTimeout(signoutTimeout);
    }

    if (timeoutState.timeRemaining <= INITIAL_TIME_REMAINING && timeoutState.timeRemaining % SCREEN_READER_UPDATE_INTERVAL === 0) {
      dispatch({
        type: 'UPDATE_SCREEN_READER_COUNTDOWN',
        payload: `${t('FOR_YOUR_SECURITY_WE_WILL_SIGN_YOU_OUT')} ${timeoutState.timeRemaining} ${t('SECONDS')}`,
      });
    }
  }, [timeoutState.timeRemaining, t, signoutHandler]);

  return timeoutState;
};

export { useTimeout, initialTimeoutState, timeoutReducer };
